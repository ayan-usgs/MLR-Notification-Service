# MLR-Notification-Service
[![Build Status](https://travis-ci.org/USGS-CIDA/MLR-Notification-Service.svg?branch=master)](https://travis-ci.org/USGS-CIDA/MLR-Notification-Service) [![Coverage Status](https://coveralls.io/repos/github/USGS-CIDA/MLR-Notification-Service/badge.svg?branch=master)](https://coveralls.io/github/USGS-CIDA/MLR-Notification-Service?branch=master)


MLR Service to Email Processing Result Notifications to Users

## Running the Application
Copy the application-test.yml file from the project root directory to an "application.yml" file also at the project root directory and change the values as needed.
Open a terminal and cd to the project root directory. Within this directory run 
```
mvn spring-boot:run
``` 
and then the application will launch and be available at http://localhost:8080/swagger-ui.html

## Using Docker
This docker image is designed to be used with Docker Swarm and as such it uses Docker Secrets for passing in configuration.

### Building the Image
The docker image is built using a jar version that has been uploaded to the CIDA artifactory. The artifact version needs to be provided as follows:
```
% docker build --mlr-version=0.1-SNAPSHOT .
```

### Creating the Docker Secret
On the docker manager of your swarm you need to create a secret for the notification service email configuration file; This secret can be called whatever you like but for the purposes of this readme I'll be using: `mlr_email_config`. This secret should be created from your `application.yml` file as shown in the following example command (run on your docker swarm manager from a location that can access the `application.yml` file):
```
docker secret create mlr_email_config application.yml
```

### Using the Docker Secret (Explanation Section, can be Skipped)
This secret then needs to be passed to your service when it is created using the `--secret` switch. The secret also needs to be mapped to a file name that SpringBoot can understand within the container, such as `application.yml`, and then this mapped path needs to be passed in to SpringBoot.

The docker file loads the application configuration file into the SpringBoot application by using the SpringBoot `--spring.config.location`. The value of the environemnt variable `MLR_EMAIL_CONFIG_FILE` is passed to this switch. 

Thus in order to get the secret loaded this environment variable must be defined to point to the mapped location of this secret. Overall this entire process means that two switches need to be included in the `docker service create` command:
```
--secret source=<secret_name>,target=<mapped-secret-location> 
--env MLR_EMAIL_CONFIG_FILE=/run/secrets/<mapped-secret-location>
```
See an example below.

### Creating the Docker Service
On the docker manager of your swarm you can create the service to run this application by running a command such as (where `mlr_notification` is the name of the built image):
```
docker service create --name mlrnotification --publish 8080:8080 --secret source=mlr_email_config,target=application.yml --env MLR_EMAIL_CONFIG_FILE=/run/secrets/application.yml mlr_notification
```

## Application Configuration File (application.yml)
* mlrEmailTemplateFrom - The email address to send emails from this service as. I.E: The `from` address for emails generated by this service.

* mlrEmailTemplateText - Text that should preface every email message body before the text that is sent through the REST URL. The message sent through the rest URL is appeneded to the end of the text provided here.

* Spring Boot Email Configuration Properties - Used by the application to connect to the email server.